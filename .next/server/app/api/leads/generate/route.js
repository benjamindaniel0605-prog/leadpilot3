"use strict";(()=>{var e={};e.id=907,e.ids=[907],e.modules={2823:e=>{e.exports=require("@supabase/ssr")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5528:e=>{e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},1877:e=>{e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},5319:e=>{e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},4074:e=>{e.exports=require("perf_hooks")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},2144:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>v,originalPathname:()=>w,patchFetch:()=>C,requestAsyncStorage:()=>N,routeModule:()=>L,serverHooks:()=>A,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>x});var o={};a.r(o),a.d(o,{POST:()=>h,runtime:()=>f});var n=a(5419),l=a(9108),i=a(9678),s=a(8070),r=a(2455),u=a(2823),c=a(9568),d=a(2030);function p(e){if(!e)return null;let t=e.trim();if(!t)return null;if(/^france$/i.test(t))return{country:"FR"};let a=t.split(",").map(e=>e.trim());return 1===a.length?{city:a[0],country:"FR"}:{city:a[0],country:a[1].toUpperCase().slice(0,2)}}let m=["Paris","Lyon","Marseille","Lille","Toulouse","Bordeaux","Nantes","Nice","Montpellier","Strasbourg","Rennes","Reims","Saint-\xc9tienne","Toulon","Angers","Grenoble","Dijon","N\xeemes","Saint-Denis","Villeurbanne"],f="nodejs",g=process.env.APOLLO_API_KEY;async function _(e,t,a,o,n){let l=0,i=[];l++,console.log(`üîç Tentative ${l}: Recherche avec tous les filtres`);let s={api_key:g,page:1,per_page:Math.min(3*o,100),q_organization_domains:"",q_organization_locations:[a]};if(t&&t.trim()&&(s.q_organization_employee_ranges=[t]),e&&e.trim()){let t=e.split(",").map(e=>e.trim()).filter(e=>e);t.length>0&&(s.q_organization_industries=t)}if(n&&n.trim()){let e=n.split(",").map(e=>e.trim()).filter(e=>e);e.length>0&&(s.q_titles=e)}console.log("\uD83D\uDCE4 Requ\xeate Apollo (\xe9tape A):",JSON.stringify(s,null,2));let r=await fetch("https://api.apollo.io/v1/people/search",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(s)});if(r.ok){let e=await r.json();if(console.log(`üì• R\xe9ponse Apollo (\xe9tape A): ${e.people?.length||0} prospects`),e.people&&e.people.length>0)return{prospects:e.people,relaxed:i,attempts:l}}if(l++,i.push("size"),console.log(`üîç Tentative ${l}: Retrait du filtre taille d'entreprise`),delete s.q_organization_employee_ranges,(r=await fetch("https://api.apollo.io/v1/people/search",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(s)})).ok){let e=await r.json();if(console.log(`üì• R\xe9ponse Apollo (\xe9tape B): ${e.people?.length||0} prospects`),e.people&&e.people.length>0)return{prospects:e.people,relaxed:i,attempts:l}}let u=p(a);if(u&&"FR"===u.country&&!u.city)for(let e of(l++,i.push("city"),console.log(`üîç Tentative ${l}: Test avec villes fran\xe7aises`),m)){let t={...s,q_organization_locations:[`${e}, France`]};if((r=await fetch("https://api.apollo.io/v1/people/search",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(t)})).ok){let t=await r.json();if(console.log(`üì• R\xe9ponse Apollo (${e}): ${t.people?.length||0} prospects`),t.people&&t.people.length>0)return i.push(`city=${e}`),{prospects:t.people,relaxed:i,attempts:l}}}if(l++,i.push("sector"),console.log(`üîç Tentative ${l}: Assouplissement du secteur`),delete s.q_organization_industries,(r=await fetch("https://api.apollo.io/v1/people/search",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(s)})).ok){let e=await r.json();if(console.log(`üì• R\xe9ponse Apollo (\xe9tape D): ${e.people?.length||0} prospects`),e.people&&e.people.length>0)return{prospects:e.people,relaxed:i,attempts:l}}return{prospects:[],relaxed:i,attempts:l}}async function h(e){try{console.log("\uD83D\uDE80 D\xe9but g\xe9n\xe9ration leads..."),console.log("\uD83D\uDD11 Cl\xe9 Apollo:",g?"Pr\xe9sente":"MANQUANTE");let t=(0,r.cookies)(),a=(0,u.createServerClient)("https://ghuifzsvtjafmykroivw.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdodWlmenN2dGphZm15a3JvaXZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTgxODUsImV4cCI6MjA2OTg3NDE4NX0.ekmuogfgI6VuewDIlGnOWUf_vVWhP0D4fn-Ukfel4rw",{cookies:{get:e=>t.get(e)?.value,set(e,a,o){t.set(e,a,o)},remove(e,a){t.set(e,"",{...a,maxAge:0})}}}),{data:{user:o},error:n}=await a.auth.getUser();if(n||!o)return console.log("‚ùå Erreur authentification:",n),s.Z.json({success:!1,data:[],reason:"UNAUTHORIZED",message:"Non autoris\xe9"},{status:401});console.log("‚úÖ Utilisateur authentifi\xe9:",o.email);let{sector:l,companySize:i,location:m,numberOfLeads:f,targetPositions:h,precision:L}=await e.json();if(console.log("\uD83D\uDCCB Payload re\xe7u:",JSON.stringify({sector:l,companySize:i,location:m,targetPositions:h,numberOfLeads:f,precision:L},null,2)),!g)return console.log("‚ùå Cl\xe9 API Apollo non configur\xe9e"),s.Z.json({success:!1,data:[],reason:"MISSING_API_KEY:APOLLO",message:"Service de g\xe9n\xe9ration de leads non disponible"},{status:503});let N=l?({technologie:"technology",tech:"technology",informatique:"information technology",it:"information technology",software:"software",saas:"software","e-commerce":"ecommerce",ecommerce:"ecommerce",finance:"financial services",banque:"financial services",assurance:"financial services",sant√©:"healthcare",sante:"healthcare",m√©dical:"healthcare",medical:"healthcare",√©ducation:"education",education:"education",immobilier:"real estate",consulting:"consulting",conseil:"consulting",marketing:"marketing",publicit√©:"advertising",publicite:"advertising",logistique:"logistics",transport:"transportation",industrie:"manufacturing",production:"manufacturing"})[l.toLowerCase().trim()]??l:"",y=p(m),A=function(e){if(!e)return null;let t=e.match(/(\d+)\s*[-‚Äì]\s*(\d+)/);return t?{min:+t[1],max:+t[2]}:e.includes("5000+")||e.includes("5000+")?{min:5e3,max:1e5}:null}(i),v=function(e){if(!e)return[];let t=e.split(",").map(e=>e.trim()).filter(e=>e),a={ceo:"CEO",directeur:"Director",directrice:"Director",manager:"Manager","chef de projet":"Project Manager",cto:"CTO",cfo:"CFO",cmo:"CMO",cso:"CSO"};return t.map(e=>a[e.toLowerCase()]??e)}(h||"");console.log("\uD83D\uDD27 Inputs normalis\xe9s:",JSON.stringify({sector:{original:l,normalized:N},location:{original:m,normalized:y},companySize:{original:i,normalized:A},positions:{original:h,normalized:v}},null,2)),console.log("\uD83D\uDD0D D\xe9but recherche Apollo avec relaxation automatique...");let{prospects:x,relaxed:w,attempts:C}=await _(N,i,m,f,h);if(0===x.length)return console.log("‚ùå Aucun prospect trouv\xe9 apr\xe8s toutes les tentatives"),s.Z.json({success:!1,data:[],reason:"NO_MATCHES_FROM_PROVIDER",meta:{provider:"apollo",attempts:C,relaxed:w},message:"Aucun prospect trouv\xe9 avec ces crit\xe8res"},{status:200});console.log(`‚úÖ ${x.length} prospects trouv\xe9s apr\xe8s ${C} tentatives`),console.log("\uD83C\uDFAF Filtres rel\xe2ch\xe9s:",w);let I=x.map(e=>({...e,aiScore:function(e,t,a,o,n){let l=50;if(t&&e.organization?.industry){let a=t.toLowerCase().split(",").map(e=>e.trim()),o=e.organization.industry.toLowerCase();a.some(e=>o.includes(e))?l+=20:a.some(e=>["tech","technology","software","saas"].includes(e)&&["tech","technology","software","saas"].some(e=>o.includes(e)))&&(l+=15)}if(a&&e.organization?.employee_count_range){let t=e.organization.employee_count_range;a===t?l+=15:a.includes("1-10")&&t.includes("1-10")?l+=12:a.includes("11-50")&&t.includes("11-50")?l+=12:a.includes("51-200")&&t.includes("51-200")&&(l+=12)}if(o&&e.organization?.location){let t=o.toLowerCase(),a=e.organization.location.toLowerCase();a.includes(t)||t.includes(a)?l+=15:t.includes("france")&&a.includes("france")?l+=15:t.includes("france")&&a.includes("europe")&&(l+=10)}if(n&&e.title){let t=n.toLowerCase().split(",").map(e=>e.trim()),a=e.title.toLowerCase();t.some(e=>a.includes(e))?l+=20:t.some(e=>["ceo","directeur","manager"].includes(e)&&["ceo","director","manager","head"].some(e=>a.includes(e)))&&(l+=15)}return e.email&&(l+=10),e.linkedin_url&&(l+=5),Math.min(100,Math.max(0,l))}(e,l,i,m,h||"")})).filter(e=>e.aiScore>=60);if(0===I.length)return console.log("‚ùå Aucun prospect qualifi\xe9 apr\xe8s filtrage IA"),s.Z.json({success:!1,data:[],reason:"TOO_STRICT_FILTERS:ai_score",meta:{provider:"apollo",attempts:C,relaxed:w,totalFound:x.length},message:"Aucun prospect qualifi\xe9 trouv\xe9"},{status:200});let D=I.sort((e,t)=>t.aiScore-e.aiScore).slice(0,f);console.log(`üéØ ${D.length} prospects qualifi\xe9s apr\xe8s filtrage IA`);let S=D.map(e=>({firstName:e.first_name||e.firstName||"Pr\xe9nom",lastName:e.last_name||e.lastName||"Nom",email:e.email||`${e.first_name||"prenom"}.${e.last_name||"nom"}@${e.organization?.name||"company"}.com`,company:e.organization?.name||"Entreprise",sector:e.organization?.industry||l||"Technologie",position:e.title||"Poste",aiScore:e.aiScore,status:"new"}));console.log("\uD83C\uDFAD Leads finaux cr\xe9\xe9s:",S);let O=S.map(e=>({userId:o.id,firstName:e.firstName,lastName:e.lastName,email:e.email,company:e.company,sector:e.sector,position:e.position,aiScore:e.aiScore,status:e.status,source:"apollo"})),T=[];for(let e of O){let[t]=await c.db.insert(d.Rc).values(e).returning();T.push(t)}return console.log("‚úÖ Leads sauvegard\xe9s en base:",T),s.Z.json({success:!0,data:T,meta:{provider:"apollo",totalFound:x.length,qualifiedCount:I.length,attempts:C,relaxed:w.length>0?w:void 0},message:`${f} lead${f>1?"s":""} g\xe9n\xe9r\xe9${f>1?"s":""} avec succ\xe8s !`})}catch(e){return console.error("‚ùå Erreur g\xe9n\xe9rale:",e),s.Z.json({success:!1,data:[],reason:"INTERNAL_ERROR",message:"Erreur lors de la g\xe9n\xe9ration de leads"},{status:500})}}let L=new n.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/leads/generate/route",pathname:"/api/leads/generate",filename:"route",bundlePath:"app/api/leads/generate/route"},resolvedPagePath:"C:\\Users\\benja\\Desktop\\LeadPilot SaaS\\LeadPilot\\app\\api\\leads\\generate\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:N,staticGenerationAsyncStorage:y,serverHooks:A,headerHooks:v,staticGenerationBailout:x}=L,w="/api/leads/generate/route";function C(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:y})}},9568:(e,t,a)=>{a.d(t,{db:()=>s});var o=a(1309),n=a(5669);let l=process.env.DATABASE_URL,i=(0,n.Z)(l),s=(0,o.t)(i)},2030:(e,t,a)=>{a.d(t,{Rc:()=>p,rC:()=>d});var o=a(2393),n=a(6155),l=a(1930),i=a(573),s=a(2561),r=a(6402),u=a(5887),c=a(6664);(0,n.af)("sessions",{sid:(0,l.L7)("sid").primaryKey(),sess:(0,i.JB)("sess").notNull(),expire:(0,s.AB)("expire").notNull()});let d=(0,n.af)("users",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),email:(0,l.L7)("email").unique(),firstName:(0,l.L7)("first_name"),lastName:(0,l.L7)("last_name"),profileImageUrl:(0,l.L7)("profile_image_url"),plan:(0,l.L7)("plan").notNull().default("free"),stripeCustomerId:(0,l.L7)("stripe_customer_id"),stripeSubscriptionId:(0,l.L7)("stripe_subscription_id"),leadsUsed:(0,r._L)("leads_used").notNull().default(0),aiVariationsUsed:(0,r._L)("ai_variations_used").notNull().default(0),variationHistory:(0,i.JB)("variation_history").default([]),googleEmailConnected:(0,u.O7)("google_email_connected").default(!1),googleEmailToken:(0,c.fL)("google_email_token"),googleRefreshToken:(0,c.fL)("google_refresh_token"),outlookEmailConnected:(0,u.O7)("outlook_email_connected").default(!1),outlookEmailToken:(0,c.fL)("outlook_email_token"),outlookRefreshToken:(0,c.fL)("outlook_refresh_token"),connectedEmailAddress:(0,l.L7)("connected_email_address"),createdAt:(0,s.AB)("created_at").defaultNow(),updatedAt:(0,s.AB)("updated_at").defaultNow()});(0,n.af)("templates",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),name:(0,l.L7)("name").notNull(),subject:(0,c.fL)("subject").notNull(),content:(0,c.fL)("content").notNull(),plan:(0,l.L7)("plan").notNull(),category:(0,l.L7)("category"),variables:(0,i.JB)("variables"),timesUsed:(0,r._L)("times_used").notNull().default(0),openRate:(0,r._L)("open_rate").default(0),createdAt:(0,s.AB)("created_at").defaultNow()});let p=(0,n.af)("leads",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,l.L7)("user_id").notNull().references(()=>d.id),firstName:(0,l.L7)("first_name").notNull(),lastName:(0,l.L7)("last_name").notNull(),email:(0,l.L7)("email").notNull(),company:(0,l.L7)("company").notNull(),sector:(0,l.L7)("sector"),position:(0,l.L7)("position"),aiScore:(0,r._L)("ai_score"),status:(0,l.L7)("status").notNull().default("new"),source:(0,l.L7)("source").default("external"),notes:(0,c.fL)("notes"),createdAt:(0,s.AB)("created_at").defaultNow(),updatedAt:(0,s.AB)("updated_at").defaultNow()}),m=(0,n.af)("custom_emails",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,l.L7)("user_id").notNull(),name:(0,l.L7)("name").notNull(),subject:(0,c.fL)("subject").notNull(),content:(0,c.fL)("content").notNull(),baseTemplateId:(0,l.L7)("base_template_id"),createdAt:(0,s.AB)("created_at").defaultNow(),updatedAt:(0,s.AB)("updated_at").defaultNow()}),f=(0,n.af)("campaigns",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,l.L7)("user_id").notNull().references(()=>d.id),name:(0,l.L7)("name").notNull(),emailId:(0,l.L7)("email_id").notNull().references(()=>m.id),leadTargets:(0,l.L7)("lead_targets").notNull(),status:(0,l.L7)("status").notNull().default("draft"),totalSent:(0,r._L)("total_sent").notNull().default(0),totalOpened:(0,r._L)("total_opened").notNull().default(0),totalClicked:(0,r._L)("total_clicked").notNull().default(0),totalReplied:(0,r._L)("total_replied").notNull().default(0),scheduledAt:(0,s.AB)("scheduled_at"),createdAt:(0,s.AB)("created_at").defaultNow(),updatedAt:(0,s.AB)("updated_at").defaultNow()});(0,n.af)("campaign_emails",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),campaignId:(0,l.L7)("campaign_id").notNull().references(()=>f.id),leadId:(0,l.L7)("lead_id").notNull().references(()=>p.id),status:(0,l.L7)("status").notNull().default("pending"),sentAt:(0,s.AB)("sent_at"),openedAt:(0,s.AB)("opened_at"),clickedAt:(0,s.AB)("clicked_at"),repliedAt:(0,s.AB)("replied_at"),createdAt:(0,s.AB)("created_at").defaultNow()});let g=(0,n.af)("sequences",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,l.L7)("user_id").notNull().references(()=>d.id),name:(0,l.L7)("name").notNull(),description:(0,c.fL)("description"),status:(0,l.L7)("status").notNull().default("active"),createdAt:(0,s.AB)("created_at").defaultNow(),updatedAt:(0,s.AB)("updated_at").defaultNow()});(0,n.af)("sequence_steps",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),sequenceId:(0,l.L7)("sequence_id").notNull().references(()=>g.id,{onDelete:"cascade"}),stepOrder:(0,r._L)("step_order").notNull(),delayDays:(0,r._L)("delay_days").notNull().default(0),delayHours:(0,r._L)("delay_hours").notNull().default(0),emailTemplateId:(0,l.L7)("email_template_id").references(()=>m.id),subject:(0,l.L7)("subject"),content:(0,c.fL)("content"),createdAt:(0,s.AB)("created_at").defaultNow()}),(0,n.af)("sequence_enrollments",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),sequenceId:(0,l.L7)("sequence_id").notNull().references(()=>g.id,{onDelete:"cascade"}),leadId:(0,l.L7)("lead_id").notNull().references(()=>p.id),status:(0,l.L7)("status").notNull().default("active"),currentStep:(0,r._L)("current_step").notNull().default(0),nextSendAt:(0,s.AB)("next_send_at"),completedAt:(0,s.AB)("completed_at"),createdAt:(0,s.AB)("created_at").defaultNow(),updatedAt:(0,s.AB)("updated_at").defaultNow()}),(0,n.af)("bookings",{id:(0,l.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,l.L7)("user_id").notNull().references(()=>d.id),leadId:(0,l.L7)("lead_id").references(()=>p.id),title:(0,l.L7)("title").notNull(),description:(0,c.fL)("description"),startTime:(0,s.AB)("start_time").notNull(),endTime:(0,s.AB)("end_time").notNull(),status:(0,l.L7)("status").notNull().default("scheduled"),meetingType:(0,l.L7)("meeting_type").default("video"),conversionStatus:(0,l.L7)("conversion_status"),contactName:(0,l.L7)("contact_name"),contactEmail:(0,l.L7)("contact_email"),contactPhone:(0,l.L7)("contact_phone"),company:(0,l.L7)("company"),createdAt:(0,s.AB)("created_at").defaultNow()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[638,206,866,455],()=>a(2144));module.exports=o})();