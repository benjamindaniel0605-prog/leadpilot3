"use strict";(()=>{var e={};e.id=907,e.ids=[907],e.modules={2823:e=>{e.exports=require("@supabase/ssr")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5528:e=>{e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},1877:e=>{e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},5319:e=>{e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},4074:e=>{e.exports=require("perf_hooks")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},3196:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>h,originalPathname:()=>v,patchFetch:()=>I,requestAsyncStorage:()=>N,routeModule:()=>L,serverHooks:()=>A,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>x});var o={};a.r(o),a.d(o,{POST:()=>_});var r=a(5419),n=a(9108),l=a(9678),i=a(8070),s=a(2823),u=a(2455),d=a(9568),c=a(2030);let p=process.env.APOLLO_API_KEY,m=process.env.OPENAI_API_KEY;async function _(e){try{let t=(0,u.cookies)(),a=(0,s.createServerClient)("https://ghuifzsvtjafmykroivw.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdodWlmenN2dGphZm15a3JvaXZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTgxODUsImV4cCI6MjA2OTg3NDE4NX0.ekmuogfgI6VuewDIlGnOWUf_vVWhP0D4fn-Ukfel4rw",{cookies:{get:e=>t.get(e)?.value,set(e,a,o){t.set(e,a,o)},remove(e,a){t.set(e,"",{...a,maxAge:0})}}}),{data:{user:o},error:r}=await a.auth.getUser();if(r||!o)return i.Z.json({error:"Non authentifi\xe9"},{status:401});let{sector:n,companySize:l,location:_,targetPositions:L,precision:N,numberOfLeads:y}=await e.json();if(!p||!m)return i.Z.json({error:"Configuration API manquante"},{status:500});let A=await f(n,l,_,y,L);if(!A.length)return i.Z.json({error:"Aucun prospect trouv\xe9 avec ces crit\xe8res"},{status:404});let h=await g(A,n,y,N),x=[];for(let e of h){let[t]=await d.db.insert(c.Rc).values({userId:o.id,firstName:e.firstName,lastName:e.lastName,email:e.email,company:e.company,sector:e.sector,position:e.position,aiScore:e.aiScore,status:"new",source:"ai_generated",notes:`Lead g\xe9n\xe9r\xe9 automatiquement par IA - Score: ${e.aiScore}%`}).returning();x.push(t)}return i.Z.json({leads:x,message:`${x.length} leads g\xe9n\xe9r\xe9s avec succ\xe8s`})}catch(e){return console.error("Erreur g\xe9n\xe9ration leads:",e),i.Z.json({error:"Erreur lors de la g\xe9n\xe9ration des leads"},{status:500})}}async function f(e,t,a,o,r){try{let n={api_key:p,page:1,per_page:Math.min(3*o,100),q_organization_domains:"",q_organization_locations:[a]};if(t&&t.trim()&&(n.q_organization_employee_ranges=[t]),e&&e.trim()){let t=e.split(",").map(e=>e.trim()).filter(e=>e);t.length>0&&(n.q_organization_industries=t)}if(r&&r.trim()){let e=r.split(",").map(e=>e.trim()).filter(e=>e);e.length>0&&(n.q_titles=e)}console.log("Requ\xeate Apollo:",JSON.stringify(n,null,2));let l=await fetch("https://api.apollo.io/v1/people/search",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify(n)});if(!l.ok){let e=await l.text();throw console.error("Erreur Apollo:",l.status,e),Error(`Erreur Apollo: ${l.status} - ${e}`)}let i=await l.json();if(console.log("R\xe9ponse Apollo:",JSON.stringify(i,null,2)),!i.people||0===i.people.length){console.log("Aucun prospect trouv\xe9 avec ces crit\xe8res Apollo"),console.log("Tentative de recherche plus large...");let e=await fetch("https://api.apollo.io/v1/people/search",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"},body:JSON.stringify({api_key:p,page:1,per_page:Math.min(3*o,100),q_organization_locations:[a]})});if(e.ok){let t=await e.json();if(console.log("R\xe9ponse fallback Apollo:",JSON.stringify(t,null,2)),t.people&&t.people.length>0)return console.log(`Fallback r\xe9ussi: ${t.people.length} prospects trouv\xe9s`),t.people}return[]}return i.people}catch(e){return console.error("Erreur recherche Apollo:",e),[]}}async function g(e,t,a,o){try{let r=`
    Tu es un expert en qualification de leads B2B. Analyse ces prospects et attribue un score de qualification de 0 \xe0 100%.

    Crit\xe8res de qualification:
    - Secteur cible: ${t}
    - Sp\xe9cialisation: ${o||"Non sp\xe9cifi\xe9e"}
    - Pertinence du poste pour le secteur
    - Qualit\xe9 de l'entreprise
    - Potentiel commercial

    Prospects \xe0 analyser:
    ${e.map(e=>`- ${e.first_name} ${e.last_name} (${e.email})
       Poste: ${e.title}
       Entreprise: ${e.company_name} (${e.company_industry})
       Taille: ${e.company_size}
       Localisation: ${e.city}, ${e.country}`).join("\n")}

    Retourne uniquement un JSON avec cette structure:
    {
      "leads": [
        {
          "firstName": "string",
          "lastName": "string", 
          "email": "string",
          "position": "string",
          "company": "string",
          "sector": "string",
          "aiScore": number
        }
      ]
    }

    S\xe9lectionne les ${a} meilleurs prospects et attribue un score r\xe9aliste.
    `,n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${m}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4",messages:[{role:"system",content:"Tu es un expert en qualification de leads B2B. R\xe9ponds uniquement en JSON valide."},{role:"user",content:r}],temperature:.3,max_tokens:2e3})});if(!n.ok)throw Error(`Erreur OpenAI: ${n.status}`);let l=await n.json(),i=l.choices[0]?.message?.content;if(!i)throw Error("R\xe9ponse OpenAI invalide");return JSON.parse(i).leads||[]}catch(t){return console.error("Erreur qualification OpenAI:",t),e.slice(0,a).map(e=>({firstName:e.first_name,lastName:e.last_name,email:e.email,position:e.title,company:e.company_name,sector:e.company_industry,aiScore:75}))}}let L=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/leads/generate/route",pathname:"/api/leads/generate",filename:"route",bundlePath:"app/api/leads/generate/route"},resolvedPagePath:"C:\\Users\\benja\\Desktop\\LeadPilot SaaS\\LeadPilot\\app\\api\\leads\\generate\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:N,staticGenerationAsyncStorage:y,serverHooks:A,headerHooks:h,staticGenerationBailout:x}=L,v="/api/leads/generate/route";function I(){return(0,l.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:y})}},9568:(e,t,a)=>{a.d(t,{db:()=>i});var o=a(1309),r=a(5669);let n=process.env.DATABASE_URL,l=(0,r.Z)(n),i=(0,o.t)(l)},2030:(e,t,a)=>{a.d(t,{Rc:()=>p,rC:()=>c});var o=a(2393),r=a(6155),n=a(1930),l=a(573),i=a(2561),s=a(6402),u=a(5887),d=a(6664);(0,r.af)("sessions",{sid:(0,n.L7)("sid").primaryKey(),sess:(0,l.JB)("sess").notNull(),expire:(0,i.AB)("expire").notNull()});let c=(0,r.af)("users",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),email:(0,n.L7)("email").unique(),firstName:(0,n.L7)("first_name"),lastName:(0,n.L7)("last_name"),profileImageUrl:(0,n.L7)("profile_image_url"),plan:(0,n.L7)("plan").notNull().default("free"),stripeCustomerId:(0,n.L7)("stripe_customer_id"),stripeSubscriptionId:(0,n.L7)("stripe_subscription_id"),leadsUsed:(0,s._L)("leads_used").notNull().default(0),aiVariationsUsed:(0,s._L)("ai_variations_used").notNull().default(0),variationHistory:(0,l.JB)("variation_history").default([]),googleEmailConnected:(0,u.O7)("google_email_connected").default(!1),googleEmailToken:(0,d.fL)("google_email_token"),googleRefreshToken:(0,d.fL)("google_refresh_token"),outlookEmailConnected:(0,u.O7)("outlook_email_connected").default(!1),outlookEmailToken:(0,d.fL)("outlook_email_token"),outlookRefreshToken:(0,d.fL)("outlook_refresh_token"),connectedEmailAddress:(0,n.L7)("connected_email_address"),createdAt:(0,i.AB)("created_at").defaultNow(),updatedAt:(0,i.AB)("updated_at").defaultNow()});(0,r.af)("templates",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),name:(0,n.L7)("name").notNull(),subject:(0,d.fL)("subject").notNull(),content:(0,d.fL)("content").notNull(),plan:(0,n.L7)("plan").notNull(),category:(0,n.L7)("category"),variables:(0,l.JB)("variables"),timesUsed:(0,s._L)("times_used").notNull().default(0),openRate:(0,s._L)("open_rate").default(0),createdAt:(0,i.AB)("created_at").defaultNow()});let p=(0,r.af)("leads",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull().references(()=>c.id),firstName:(0,n.L7)("first_name").notNull(),lastName:(0,n.L7)("last_name").notNull(),email:(0,n.L7)("email").notNull(),company:(0,n.L7)("company").notNull(),sector:(0,n.L7)("sector"),position:(0,n.L7)("position"),aiScore:(0,s._L)("ai_score"),status:(0,n.L7)("status").notNull().default("new"),source:(0,n.L7)("source").default("external"),notes:(0,d.fL)("notes"),createdAt:(0,i.AB)("created_at").defaultNow(),updatedAt:(0,i.AB)("updated_at").defaultNow()}),m=(0,r.af)("custom_emails",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull(),name:(0,n.L7)("name").notNull(),subject:(0,d.fL)("subject").notNull(),content:(0,d.fL)("content").notNull(),baseTemplateId:(0,n.L7)("base_template_id"),createdAt:(0,i.AB)("created_at").defaultNow(),updatedAt:(0,i.AB)("updated_at").defaultNow()}),_=(0,r.af)("campaigns",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull().references(()=>c.id),name:(0,n.L7)("name").notNull(),emailId:(0,n.L7)("email_id").notNull().references(()=>m.id),leadTargets:(0,n.L7)("lead_targets").notNull(),status:(0,n.L7)("status").notNull().default("draft"),totalSent:(0,s._L)("total_sent").notNull().default(0),totalOpened:(0,s._L)("total_opened").notNull().default(0),totalClicked:(0,s._L)("total_clicked").notNull().default(0),totalReplied:(0,s._L)("total_replied").notNull().default(0),scheduledAt:(0,i.AB)("scheduled_at"),createdAt:(0,i.AB)("created_at").defaultNow(),updatedAt:(0,i.AB)("updated_at").defaultNow()});(0,r.af)("campaign_emails",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),campaignId:(0,n.L7)("campaign_id").notNull().references(()=>_.id),leadId:(0,n.L7)("lead_id").notNull().references(()=>p.id),status:(0,n.L7)("status").notNull().default("pending"),sentAt:(0,i.AB)("sent_at"),openedAt:(0,i.AB)("opened_at"),clickedAt:(0,i.AB)("clicked_at"),repliedAt:(0,i.AB)("replied_at"),createdAt:(0,i.AB)("created_at").defaultNow()});let f=(0,r.af)("sequences",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull().references(()=>c.id),name:(0,n.L7)("name").notNull(),description:(0,d.fL)("description"),status:(0,n.L7)("status").notNull().default("active"),createdAt:(0,i.AB)("created_at").defaultNow(),updatedAt:(0,i.AB)("updated_at").defaultNow()});(0,r.af)("sequence_steps",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),sequenceId:(0,n.L7)("sequence_id").notNull().references(()=>f.id,{onDelete:"cascade"}),stepOrder:(0,s._L)("step_order").notNull(),delayDays:(0,s._L)("delay_days").notNull().default(0),delayHours:(0,s._L)("delay_hours").notNull().default(0),emailTemplateId:(0,n.L7)("email_template_id").references(()=>m.id),subject:(0,n.L7)("subject"),content:(0,d.fL)("content"),createdAt:(0,i.AB)("created_at").defaultNow()}),(0,r.af)("sequence_enrollments",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),sequenceId:(0,n.L7)("sequence_id").notNull().references(()=>f.id,{onDelete:"cascade"}),leadId:(0,n.L7)("lead_id").notNull().references(()=>p.id),status:(0,n.L7)("status").notNull().default("active"),currentStep:(0,s._L)("current_step").notNull().default(0),nextSendAt:(0,i.AB)("next_send_at"),completedAt:(0,i.AB)("completed_at"),createdAt:(0,i.AB)("created_at").defaultNow(),updatedAt:(0,i.AB)("updated_at").defaultNow()}),(0,r.af)("bookings",{id:(0,n.L7)("id").primaryKey().default(o.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull().references(()=>c.id),leadId:(0,n.L7)("lead_id").references(()=>p.id),title:(0,n.L7)("title").notNull(),description:(0,d.fL)("description"),startTime:(0,i.AB)("start_time").notNull(),endTime:(0,i.AB)("end_time").notNull(),status:(0,n.L7)("status").notNull().default("scheduled"),meetingType:(0,n.L7)("meeting_type").default("video"),conversionStatus:(0,n.L7)("conversion_status"),contactName:(0,n.L7)("contact_name"),contactEmail:(0,n.L7)("contact_email"),contactPhone:(0,n.L7)("contact_phone"),company:(0,n.L7)("company"),createdAt:(0,i.AB)("created_at").defaultNow()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[638,206,866,455],()=>a(3196));module.exports=o})();