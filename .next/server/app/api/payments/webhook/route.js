"use strict";(()=>{var e={};e.id=4,e.ids=[4],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},4074:e=>{e.exports=require("perf_hooks")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},3837:e=>{e.exports=require("util")},1651:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>L,originalPathname:()=>N,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>A});var r={};a.r(r),a.d(r,{POST:()=>p});var o=a(5419),n=a(9108),l=a(9678),d=a(8070),s=a(5922),i=a(9568),u=a(2030),c=a(2279);async function p(e){let t;let a=await e.text(),r=e.headers.get("stripe-signature");if(!r)return d.Z.json({error:"Signature manquante"},{status:400});try{t=s.Ag.webhooks.constructEvent(a,r,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Erreur webhook:",e),d.Z.json({error:"Signature invalide"},{status:400})}try{switch(t.type){case"checkout.session.completed":let e=t.data.object;await i.db.update(u.rC).set({stripeCustomerId:e.customer,stripeSubscriptionId:e.subscription,plan:e.metadata.plan,updatedAt:new Date}).where((0,c.eq)(u.rC.id,e.metadata.userId)),console.log(`✅ Abonnement cr\xe9\xe9 pour l'utilisateur ${e.metadata.userId}`);break;case"customer.subscription.updated":let a=t.data.object;await i.db.update(u.rC).set({plan:a.metadata.plan||"pro",updatedAt:new Date}).where((0,c.eq)(u.rC.stripeSubscriptionId,a.id)),console.log(`✅ Abonnement mis \xe0 jour: ${a.id}`);break;case"customer.subscription.deleted":let r=t.data.object;await i.db.update(u.rC).set({plan:"free",stripeSubscriptionId:null,updatedAt:new Date}).where((0,c.eq)(u.rC.stripeSubscriptionId,r.id)),console.log(`✅ Abonnement supprim\xe9: ${r.id}`);break;default:console.log(`⚠️ \xc9v\xe9nement non g\xe9r\xe9: ${t.type}`)}return d.Z.json({received:!0})}catch(e){return console.error("Erreur traitement webhook:",e),d.Z.json({error:"Erreur traitement webhook"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"C:\\Users\\benja\\Desktop\\LeadPilot SaaS\\LeadPilot\\app\\api\\payments\\webhook\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:y,headerHooks:L,staticGenerationBailout:A}=_,N="/api/payments/webhook/route";function g(){return(0,l.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},9568:(e,t,a)=>{a.d(t,{db:()=>d});var r=a(1309),o=a(5669);let n=process.env.DATABASE_URL,l=(0,o.Z)(n),d=(0,r.t)(l)},2030:(e,t,a)=>{a.d(t,{Rc:()=>p,rC:()=>c});var r=a(2393),o=a(6155),n=a(1930),l=a(573),d=a(2561),s=a(6402),i=a(5887),u=a(6664);(0,o.af)("sessions",{sid:(0,n.L7)("sid").primaryKey(),sess:(0,l.JB)("sess").notNull(),expire:(0,d.AB)("expire").notNull()});let c=(0,o.af)("users",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),email:(0,n.L7)("email").unique(),firstName:(0,n.L7)("first_name"),lastName:(0,n.L7)("last_name"),profileImageUrl:(0,n.L7)("profile_image_url"),plan:(0,n.L7)("plan").notNull().default("free"),stripeCustomerId:(0,n.L7)("stripe_customer_id"),stripeSubscriptionId:(0,n.L7)("stripe_subscription_id"),leadsUsed:(0,s._L)("leads_used").notNull().default(0),aiVariationsUsed:(0,s._L)("ai_variations_used").notNull().default(0),variationHistory:(0,l.JB)("variation_history").default([]),googleEmailConnected:(0,i.O7)("google_email_connected").default(!1),googleEmailToken:(0,u.fL)("google_email_token"),googleRefreshToken:(0,u.fL)("google_refresh_token"),outlookEmailConnected:(0,i.O7)("outlook_email_connected").default(!1),outlookEmailToken:(0,u.fL)("outlook_email_token"),outlookRefreshToken:(0,u.fL)("outlook_refresh_token"),connectedEmailAddress:(0,n.L7)("connected_email_address"),createdAt:(0,d.AB)("created_at").defaultNow(),updatedAt:(0,d.AB)("updated_at").defaultNow()});(0,o.af)("templates",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),name:(0,n.L7)("name").notNull(),subject:(0,u.fL)("subject").notNull(),content:(0,u.fL)("content").notNull(),plan:(0,n.L7)("plan").notNull(),category:(0,n.L7)("category"),variables:(0,l.JB)("variables"),timesUsed:(0,s._L)("times_used").notNull().default(0),openRate:(0,s._L)("open_rate").default(0),createdAt:(0,d.AB)("created_at").defaultNow()});let p=(0,o.af)("leads",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull().references(()=>c.id),firstName:(0,n.L7)("first_name").notNull(),lastName:(0,n.L7)("last_name").notNull(),email:(0,n.L7)("email").notNull(),company:(0,n.L7)("company").notNull(),sector:(0,n.L7)("sector"),position:(0,n.L7)("position"),aiScore:(0,s._L)("ai_score"),status:(0,n.L7)("status").notNull().default("new"),source:(0,n.L7)("source").default("external"),notes:(0,u.fL)("notes"),createdAt:(0,d.AB)("created_at").defaultNow(),updatedAt:(0,d.AB)("updated_at").defaultNow()}),_=(0,o.af)("custom_emails",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull(),name:(0,n.L7)("name").notNull(),subject:(0,u.fL)("subject").notNull(),content:(0,u.fL)("content").notNull(),baseTemplateId:(0,n.L7)("base_template_id"),createdAt:(0,d.AB)("created_at").defaultNow(),updatedAt:(0,d.AB)("updated_at").defaultNow()}),m=(0,o.af)("campaigns",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull().references(()=>c.id),name:(0,n.L7)("name").notNull(),emailId:(0,n.L7)("email_id").notNull().references(()=>_.id),leadTargets:(0,n.L7)("lead_targets").notNull(),status:(0,n.L7)("status").notNull().default("draft"),totalSent:(0,s._L)("total_sent").notNull().default(0),totalOpened:(0,s._L)("total_opened").notNull().default(0),totalClicked:(0,s._L)("total_clicked").notNull().default(0),totalReplied:(0,s._L)("total_replied").notNull().default(0),scheduledAt:(0,d.AB)("scheduled_at"),createdAt:(0,d.AB)("created_at").defaultNow(),updatedAt:(0,d.AB)("updated_at").defaultNow()});(0,o.af)("campaign_emails",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),campaignId:(0,n.L7)("campaign_id").notNull().references(()=>m.id),leadId:(0,n.L7)("lead_id").notNull().references(()=>p.id),status:(0,n.L7)("status").notNull().default("pending"),sentAt:(0,d.AB)("sent_at"),openedAt:(0,d.AB)("opened_at"),clickedAt:(0,d.AB)("clicked_at"),repliedAt:(0,d.AB)("replied_at"),createdAt:(0,d.AB)("created_at").defaultNow()});let f=(0,o.af)("sequences",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull().references(()=>c.id),name:(0,n.L7)("name").notNull(),description:(0,u.fL)("description"),status:(0,n.L7)("status").notNull().default("active"),createdAt:(0,d.AB)("created_at").defaultNow(),updatedAt:(0,d.AB)("updated_at").defaultNow()});(0,o.af)("sequence_steps",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),sequenceId:(0,n.L7)("sequence_id").notNull().references(()=>f.id,{onDelete:"cascade"}),stepOrder:(0,s._L)("step_order").notNull(),delayDays:(0,s._L)("delay_days").notNull().default(0),delayHours:(0,s._L)("delay_hours").notNull().default(0),emailTemplateId:(0,n.L7)("email_template_id").references(()=>_.id),subject:(0,n.L7)("subject"),content:(0,u.fL)("content"),createdAt:(0,d.AB)("created_at").defaultNow()}),(0,o.af)("sequence_enrollments",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),sequenceId:(0,n.L7)("sequence_id").notNull().references(()=>f.id,{onDelete:"cascade"}),leadId:(0,n.L7)("lead_id").notNull().references(()=>p.id),status:(0,n.L7)("status").notNull().default("active"),currentStep:(0,s._L)("current_step").notNull().default(0),nextSendAt:(0,d.AB)("next_send_at"),completedAt:(0,d.AB)("completed_at"),createdAt:(0,d.AB)("created_at").defaultNow(),updatedAt:(0,d.AB)("updated_at").defaultNow()}),(0,o.af)("bookings",{id:(0,n.L7)("id").primaryKey().default(r.i6`gen_random_uuid()`),userId:(0,n.L7)("user_id").notNull().references(()=>c.id),leadId:(0,n.L7)("lead_id").references(()=>p.id),title:(0,n.L7)("title").notNull(),description:(0,u.fL)("description"),startTime:(0,d.AB)("start_time").notNull(),endTime:(0,d.AB)("end_time").notNull(),status:(0,n.L7)("status").notNull().default("scheduled"),meetingType:(0,n.L7)("meeting_type").default("video"),conversionStatus:(0,n.L7)("conversion_status"),contactName:(0,n.L7)("contact_name"),contactEmail:(0,n.L7)("contact_email"),contactPhone:(0,n.L7)("contact_phone"),company:(0,n.L7)("company"),createdAt:(0,d.AB)("created_at").defaultNow()})},5922:(e,t,a)=>{a.d(t,{Ag:()=>r,Mc:()=>l});let r=new(a(1211)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}),o={starter_monthly:"prod_SpCbKLQ1sZ6H6Z",starter_yearly:"prod_SpCcxIOKwQWk13",pro_monthly:"prod_SpCfDKSrwoD1Ps",pro_yearly:"prod_SpCghZUmmJzWJ9",growth_monthly:"prod_SpChKR7EbDQJ7C",growth_yearly:"prod_SpCiuTrFalDd34"},n={starter:{monthly:o.starter_monthly,yearly:o.starter_yearly,price:{monthly:49,yearly:490},features:["Jusqu'\xe0 100 leads par mois","Scoring IA basique","Templates d'emails","Support email"]},pro:{monthly:o.pro_monthly,yearly:o.pro_yearly,price:{monthly:99,yearly:990},features:["Jusqu'\xe0 500 leads par mois","Scoring IA avanc\xe9","Int\xe9gration Gmail","Analytics d\xe9taill\xe9s","Support prioritaire"]},growth:{monthly:o.growth_monthly,yearly:o.growth_yearly,price:{monthly:299,yearly:2990},features:["Leads illimit\xe9s","Scoring IA premium","Int\xe9grations avanc\xe9es","API personnalis\xe9e","Manager de compte d\xe9di\xe9","Formation personnalis\xe9e"]}};async function l({plan:e,isYearly:t,userId:a,successUrl:o,cancelUrl:l}){let d=t?n[e]?.yearly:n[e]?.monthly;if(!d)throw Error(`Plan ${e} non trouv\xe9`);return await r.checkout.sessions.create({payment_method_types:["card"],line_items:[{price_data:{currency:"eur",product:d,unit_amount:t?n[e]?.price.yearly*100:n[e]?.price.monthly*100,recurring:{interval:t?"year":"month"}},quantity:1}],mode:"subscription",success_url:o,cancel_url:l,metadata:{userId:a,plan:e,isYearly:t.toString()}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[638,206,866,211],()=>a(1651));module.exports=r})();